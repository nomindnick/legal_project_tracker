{% extends "base.html" %}

{% block title %}Edit: {{ project.project_name }} - Legal Project Tracker{% endblock %}

{% block extra_css %}
{# Google Fonts for Legal Precision theme #}
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Libre+Baskerville:wght@400;700&family=Source+Sans+3:wght@400;500;600&display=swap" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="project-edit-page py-4">
    <div class="container">
        <!-- Breadcrumb -->
        <div class="edit-top-bar">
            <a href="{{ url_for('projects.view_project', id=project.id) }}" class="back-link">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8z"/>
                </svg>
                Cancel &amp; Return to Project
            </a>
        </div>

        <!-- Edit Header -->
        <div class="edit-header-card">
            <div class="edit-header-content">
                <div class="edit-badge">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168l10-10zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207 11.207 2.5zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293l6.5-6.5z"/>
                    </svg>
                    Editing
                </div>
                <h1 class="edit-title">{{ project.project_name }}</h1>
                <p class="edit-subtitle">Project #{{ project.id }}</p>
            </div>
        </div>

        <!-- Edit Form -->
        <form action="{{ url_for('projects.update_project_form', id=project.id) }}" method="POST" class="edit-form">
            <div class="edit-grid">
                <!-- Left Column: Core Fields -->
                <div class="edit-column-left">
                    <div class="edit-section-card">
                        <div class="section-header">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M14.5 3a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-.5.5h-13a.5.5 0 0 1-.5-.5v-9a.5.5 0 0 1 .5-.5h13zm-13-1A1.5 1.5 0 0 0 0 3.5v9A1.5 1.5 0 0 0 1.5 14h13a1.5 1.5 0 0 0 1.5-1.5v-9A1.5 1.5 0 0 0 14.5 2h-13z"/>
                                <path d="M3 5.5a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5zM3 8a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9A.5.5 0 0 1 3 8zm0 2.5a.5.5 0 0 1 .5-.5h6a.5.5 0 0 1 0 1h-6a.5.5 0 0 1-.5-.5z"/>
                            </svg>
                            Project Details
                        </div>
                        <div class="section-body">
                            <div class="form-field">
                                <label for="project_name" class="form-label required">Project Name</label>
                                <input type="text" id="project_name" name="project_name" class="form-control"
                                       value="{{ project.project_name }}" required>
                            </div>

                            <div class="form-field">
                                <label for="project_group" class="form-label">Project Group</label>
                                <input type="text" id="project_group" name="project_group" class="form-control"
                                       value="{{ project.project_group or '' }}"
                                       placeholder="Optional: Link related projects">
                            </div>

                            <div class="form-field">
                                <label for="department" class="form-label required">Department</label>
                                <input type="text" id="department" name="department" class="form-control"
                                       value="{{ project.department }}" required
                                       data-autocomplete="/api/autocomplete/department"
                                       autocomplete="off">
                                <div class="autocomplete-dropdown" id="department-dropdown"></div>
                            </div>

                            <div class="form-field">
                                <label for="status" class="form-label required">Status</label>
                                <select id="status" name="status" class="form-select" required>
                                    {% for status_option in statuses %}
                                    <option value="{{ status_option }}" {% if project.status == status_option %}selected{% endif %}>
                                        {{ status_option }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Team Section -->
                    <div class="edit-section-card">
                        <div class="section-header">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M7 14s-1 0-1-1 1-4 5-4 5 3 5 4-1 1-1 1H7Zm4-6a3 3 0 1 0 0-6 3 3 0 0 0 0 6Zm-5.784 6A2.238 2.238 0 0 1 5 13c0-1.355.68-2.75 1.936-3.72A6.325 6.325 0 0 0 5 9c-4 0-5 3-5 4s1 1 1 1h4.216ZM4.5 8a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5Z"/>
                            </svg>
                            Team
                        </div>
                        <div class="section-body">
                            <div class="form-field">
                                <label for="assigned_attorney" class="form-label required">Assigned Attorney</label>
                                <input type="text" id="assigned_attorney" name="assigned_attorney" class="form-control"
                                       value="{{ project.assigned_attorney }}" required
                                       data-autocomplete="/api/autocomplete/assigned_attorney"
                                       autocomplete="off">
                                <div class="autocomplete-dropdown" id="assigned_attorney-dropdown"></div>
                            </div>

                            <div class="form-field">
                                <label for="qcp_attorney" class="form-label required">QCP Attorney</label>
                                <input type="text" id="qcp_attorney" name="qcp_attorney" class="form-control"
                                       value="{{ project.qcp_attorney }}" required
                                       data-autocomplete="/api/autocomplete/qcp_attorney"
                                       autocomplete="off">
                                <div class="autocomplete-dropdown" id="qcp_attorney-dropdown"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Column: Dates & Notes -->
                <div class="edit-column-right">
                    <!-- Dates Section -->
                    <div class="edit-section-card">
                        <div class="section-header">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M3.5 0a.5.5 0 0 1 .5.5V1h8V.5a.5.5 0 0 1 1 0V1h1a2 2 0 0 1 2 2v11a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V3a2 2 0 0 1 2-2h1V.5a.5.5 0 0 1 .5-.5zM1 4v10a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V4H1z"/>
                            </svg>
                            Dates
                        </div>
                        <div class="section-body">
                            <div class="form-row">
                                <div class="form-field">
                                    <label for="date_to_client" class="form-label required">Date to Client</label>
                                    <input type="date" id="date_to_client" name="date_to_client" class="form-control"
                                           value="{{ project.date_to_client.strftime('%Y-%m-%d') if project.date_to_client else '' }}" required>
                                </div>

                                <div class="form-field">
                                    <label for="date_assigned_to_us" class="form-label required">Date Assigned to Us</label>
                                    <input type="date" id="date_assigned_to_us" name="date_assigned_to_us" class="form-control"
                                           value="{{ project.date_assigned_to_us.strftime('%Y-%m-%d') if project.date_assigned_to_us else '' }}" required>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-field">
                                    <label for="internal_deadline" class="form-label">Internal Deadline</label>
                                    <input type="date" id="internal_deadline" name="internal_deadline" class="form-control"
                                           value="{{ project.internal_deadline.strftime('%Y-%m-%d') if project.internal_deadline else '' }}">
                                </div>

                                <div class="form-field">
                                    <label for="delivery_deadline" class="form-label">Delivery Deadline</label>
                                    <input type="date" id="delivery_deadline" name="delivery_deadline" class="form-control"
                                           value="{{ project.delivery_deadline.strftime('%Y-%m-%d') if project.delivery_deadline else '' }}">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Notes Section -->
                    <div class="edit-section-card notes-section">
                        <div class="section-header">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M2.5 1A1.5 1.5 0 0 0 1 2.5v11A1.5 1.5 0 0 0 2.5 15h6.086a1.5 1.5 0 0 0 1.06-.44l4.915-4.914A1.5 1.5 0 0 0 15 8.586V2.5A1.5 1.5 0 0 0 13.5 1h-11zM2 2.5a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 .5.5v6H9.5A1.5 1.5 0 0 0 8 10.5V14H2.5a.5.5 0 0 1-.5-.5v-11zm7 11.293V10.5a.5.5 0 0 1 .5-.5h3.293L9 13.793z"/>
                            </svg>
                            Notes
                        </div>
                        <div class="section-body">
                            {% if project.notes %}
                            <div class="existing-notes">
                                <label class="notes-label">Existing Notes</label>
                                <div class="notes-display">
                                    {% set note_entries = project.notes.split('\n') %}
                                    {% for entry in note_entries if entry.strip() %}
                                    <div class="note-entry-mini">
                                        {% if entry.startswith('[') and ']: ' in entry %}
                                            {% set timestamp = entry.split(']: ')[0][1:] %}
                                            {% set content = entry.split(']: ', 1)[1] if ']: ' in entry else entry %}
                                            <span class="mini-timestamp">{{ timestamp }}</span>
                                            <span class="mini-content">{{ content }}</span>
                                        {% else %}
                                            <span class="mini-content">{{ entry }}</span>
                                        {% endif %}
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}

                            <div class="form-field add-note-field">
                                <label for="new_note" class="form-label">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" viewBox="0 0 16 16" style="vertical-align: -1px; margin-right: 4px;">
                                        <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
                                    </svg>
                                    Add New Note
                                </label>
                                <textarea id="new_note" name="new_note" class="form-control" rows="3"
                                          placeholder="Enter a note... (will be timestamped automatically)"></textarea>
                                <small class="form-hint">Notes are append-only and timestamped automatically</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Form Actions -->
            <div class="form-actions">
                <div class="actions-left">
                    <button type="button" class="btn-delete-form" onclick="confirmDelete({{ project.id }})">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5Zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5Zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6Z"/>
                            <path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1ZM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118ZM2.5 3h11V2h-11v1Z"/>
                        </svg>
                        Delete Project
                    </button>
                </div>
                <div class="actions-right">
                    <a href="{{ url_for('projects.view_project', id=project.id) }}" class="btn-cancel">Cancel</a>
                    <button type="submit" class="btn-save">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M12.736 3.97a.733.733 0 0 1 1.047 0c.286.289.29.756.01 1.05L7.88 12.01a.733.733 0 0 1-1.065.02L3.217 8.384a.757.757 0 0 1 0-1.06.733.733 0 0 1 1.047 0l3.052 3.093 5.4-6.425a.247.247 0 0 1 .02-.022Z"/>
                        </svg>
                        Save Changes
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Delete Confirmation Form (Hidden) -->
<form id="delete-form" action="{{ url_for('projects.delete_project_form', id=project.id) }}" method="POST" style="display: none;">
</form>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/autocomplete.js') }}"></script>
<script>
    function confirmDelete(projectId) {
        if (confirm('Are you sure you want to delete this project? This cannot be undone.')) {
            document.getElementById('delete-form').submit();
        }
    }

    // Initialize autocomplete on page load
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('[data-autocomplete]').forEach(input => {
            new Autocomplete(input, input.dataset.autocomplete);
        });
    });
</script>
{% endblock %}
